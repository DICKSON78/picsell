rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // ============================================
    // ADMINS COLLECTION
    // ============================================
    match /admins/{adminId} {
      // Admin can read their own document
      allow read: if isOwner(adminId);

      // Admin can update their own document
      allow update: if isOwner(adminId);

      // Allow admin creation during signup
      allow create: if isAuthenticated();

      // Prevent admin deletion
      allow delete: if false;
    }

    // ============================================
    // USERS COLLECTION (Customers)
    // ============================================
    match /users/{userId} {
      // Users can read/write their own document
      allow read, update: if isOwner(userId);

      // Allow user creation during signup
      allow create: if isAuthenticated();

      // Admins can read all users
      allow read: if isAdmin();

      // Admins can update user credits/status
      allow update: if isAdmin();

      // Prevent user deletion (or only allow admin)
      allow delete: if isAdmin();
    }

    // ============================================
    // PACKAGES COLLECTION
    // ============================================
    match /packages/{packageId} {
      // Everyone (authenticated) can read packages
      allow read: if isAuthenticated();

      // Only admins can create/update/delete packages
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // TRANSACTIONS COLLECTION
    // ============================================
    match /transactions/{transactionId} {
      // Users can read their own transactions
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Users can create their own transactions
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;

      // Admins can read all transactions
      allow read: if isAdmin();

      // Admins can update transaction status
      allow update: if isAdmin();

      // Prevent transaction deletion
      allow delete: if false;
    }

    // ============================================
    // PHOTOS COLLECTION
    // ============================================
    match /photos/{photoId} {
      // Users can read their own photos
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Users can create their own photos
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;

      // Users can update their own photos
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      // Users can delete their own photos
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      // Admins can read all photos
      allow read: if isAdmin();
    }

    // ============================================
    // SYSTEM SETTINGS COLLECTION
    // ============================================
    match /system_settings/{settingId} {
      // Everyone (authenticated) can read system settings
      allow read: if isAuthenticated();

      // Only admins can write system settings
      allow create, update: if isAdmin();

      // Prevent settings deletion
      allow delete: if false;
    }

    // ============================================
    // NOTIFICATIONS COLLECTION
    // ============================================
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Admins can create notifications for users
      allow create: if isAdmin();

      // Users can update their own notifications (mark as read)
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      // Users can delete their own notifications
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      // Admins can manage all notifications
      allow read, update, delete: if isAdmin();
    }

    // ============================================
    // CONFIG COLLECTION (Admin system config)
    // admin_defaults: seeding credentials
    // system: API tokens, system settings
    // ============================================
    match /config/{configId} {
      // Only admins can read or write config documents
      allow read, write: if isAdmin();
    }

    // ============================================
    // DEFAULT - DENY ALL OTHER COLLECTIONS
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
